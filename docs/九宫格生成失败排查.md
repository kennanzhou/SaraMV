# 九宫格生成失败排查指南

**当前实现**：九宫格只发「生成一张」请求，得到一张内含 9 格的接触表图；用户点击接触表上的分区（1–9）时，将该编号作为提示词的一部分，再请求生成该格的 2K 大图。相关代码：`src/app/lib/gridImageGen.ts`、`src/app/api/generate-grid/`、`src/app/api/generate-grid-cell/`、`Module4Video`。

---

## 1. API Key

- **检查**：`config/settings.json` 中的 `geminiApiKey` 或环境变量 `GEMINI_API_KEY` 是否已填且有效。
- **现象**：请求直接报错、401 或 "API Key not configured"。
- **解决**：在 [Google AI Studio](https://aistudio.google.com/apikey) 创建/复制 Key，确保该 Key 已开通 **Gemini API** 且未过期。

---

## 2. 使用的 SDK 与模型**

- **图片生成**需使用 **`@google/genai`**（`GoogleGenAI`），不是 `@google/generative-ai`（后者多用于纯文本/多模态理解）。
- **模型 ID** 需为图片生成专用：
  - `gemini-2.5-flash-image`（Nano Banana，速度优先）
  - `gemini-3-pro-image-preview`（Nano Banana Pro，质量优先）
- **错误示例**：使用 `gemini-2.0-flash` 等纯文本模型去“生成图片”，会失败或返回无图。
- **解决**：在九宫格调用处确认使用的是 `@google/genai` 的 `ai.models.generateContent`，且 `model` 为上述两个之一。

---

## 3. 请求体必须带 responseModalities 与 imageConfig

- 官方要求：**生成图片**时必须在 `config` 里指定：
  - `responseModalities: ['TEXT', 'IMAGE']`
  - `imageConfig`: 至少包含 `aspectRatio`，可选 `imageSize`（'1K' | '2K' | '4K'）。
- **错误示例**：只传 `contents` 和 `model`，不传 `config` 或缺少 `responseModalities`，可能只返回文字不返回图。
- **正确示例**（与官方文档一致）：

```ts
const response = await ai.models.generateContent({
  model: 'gemini-2.5-flash-image',
  contents: [
    { text: prompt },
    { inlineData: { mimeType, data: base64Data } },
  ],
  config: {
    responseModalities: ['TEXT', 'IMAGE'],
    imageConfig: {
      aspectRatio: '1:1',
      imageSize: '1K',  // 或 '2K' / '4K'
    },
  },
});
```

- **解决**：在 `gridImageGen.ts`（或等价实现）里确保每次调用都带上上述 `config`。

---

## 4. 响应中图片的解析方式

- 返回结构：`response.candidates[0].content.parts` 中，每个 part 可能是 `text` 或 `inlineData`（含 `data` base64）。
- **错误示例**：只取 `response.text()` 或假设第一 part 就是图，若模型先返回一段文字再返回图，会解析不到图。
- **正确做法**：遍历 `response.candidates?.[0]?.content?.parts`，找到带 `inlineData.data` 的 part，用其 `data` 拼成 data URL（如 `data:image/png;base64,${data}`）。
- **注意**：Gemini 3 Pro Image 可能返回多个 part（含“思考”过程），最终成图通常在最后一个含 `inlineData` 的 part；若只取第一个 part 可能拿到的是中间图而非最终图。

---

## 5. 内容政策 / 敏感内容

- 若提示词或输入图涉及裸露、暴力、侵权等，API 可能直接拒绝生成并返回错误或空图。
- **现象**：同一套代码有时成功有时失败，或仅某些格/某些提示失败。
- **解决**：简化或改写提示词与参考图，避免敏感描述；若为合规内容仍被拒，可查看返回的 `error` 或 `safetyRatings` 信息。

---

## 6. 速率限制与配额

- 九宫格会连续请求 9 次（或更多），容易触发每分钟/每日请求上限。
- **现象**：前几格成功，后面返回 429 或 “resource exhausted”。
- **解决**：在格与格之间加短延迟（如 1–2 秒）；或先实现单格生成与“单格重试”，再拼成九宫格。

---

## 7. 当前仓库状态

- 本仓库当前**没有** `generate-grid`、`gridImageGen`、Module4 等九宫格实现。
- 若你是在**其他分支/备份**里开发过九宫格，请在该分支上按上述 1–6 检查并修改。
- 若希望在本仓库重新实现九宫格，需要：
  1. 使用 `@google/genai` 的 `GoogleGenAI`。
  2. 使用模型 `gemini-2.5-flash-image` 或 `gemini-3-pro-image-preview`。
  3. 每次调用都传 `config: { responseModalities: ['TEXT','IMAGE'], imageConfig: { aspectRatio, imageSize } }`。
  4. 从 `candidates[0].content.parts` 中正确解析带 `inlineData.data` 的 part 作为成图。

---

## 参考

- [Gemini 图片生成官方文档](https://ai.google.dev/gemini-api/docs/image-generation)
- 官方 JavaScript 示例：`model: "gemini-2.5-flash-image"`，`contents` 为文本+图片，`config` 含 `responseModalities` 与 `imageConfig`。
